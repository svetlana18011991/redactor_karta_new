<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É ‚Äî Editor + Game</title>

  <!-- KaTeX (LaTeX —Ñ–æ—Ä–º—É–ª—ã) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 22px;
      --cardW: 320px;
      --cardH: 440px;
      --accent:#6aa4ff;
      --accent2:#9b7bff;
      --glow: rgba(106,164,255,.35);

      /* –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ */
      --qFont: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --qSize: 16px;
      --qColor: #eaf0ff;

      /* draw anim */
      --drawDur: 650ms;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.16) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.12) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.10) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.65), rgba(5,8,22,1));
      min-height:100vh;
    }

    body.gameOnly{ background: rgba(0,0,0,0); }

    .app{
      display:grid;
      grid-template-columns: 440px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1480px;
      margin: 0 auto;
    }
    @media (max-width: 980px){ .app{grid-template-columns:1fr} }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel-header .h{font-weight:950;letter-spacing:.2px}
    .panel-body{padding:14px}

    .errbar{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.10);
      color:#ffd6d6;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{ overflow:auto; padding:14px; }

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    input[type="color"]{
      width:100%;
      height:42px;
      border-radius:14px;
      padding:6px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
    }

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(90deg, rgba(106,164,255,.42), rgba(155,123,255,.34));
      border-color:rgba(106,164,255,.40);
      box-shadow: 0 10px 26px rgba(106,164,255,.14);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column; gap:10px;}

    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }

    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }

    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }

    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted); font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height: 660px;
      background:
        radial-gradient(900px 520px at 18% 22%, rgba(106,164,255,.16), rgba(0,0,0,0) 60%),
        radial-gradient(900px 520px at 88% 18%, rgba(155,123,255,.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14));
      box-shadow: var(--shadow2);
    }

    .preview-ui{
      position:absolute;
      left:12px;
      right:12px;
      top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
    }

    .preview-ui .left{display:flex; flex-direction:column; gap:3px}
    .preview-ui .title{font-weight:950}
    .preview-ui .sub{color:var(--muted); font-size:12px}
    .preview-ui .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .progress{
      width:220px;height:10px;border-radius:999px;overflow:hidden;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10)
    }

    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .2s ease
    }

    .counter{font-size:13px;color:var(--muted)}

    .preview-cards{
      position:absolute;
      left:0;
      right:0;
      top:118px;
      display:flex;
      justify-content:center;
      gap:56px;
      padding:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .deck-wrap{
      width: calc(var(--cardW) + 46px);
      height: calc(var(--cardH) + 90px);
      border-radius:22px;
      border:1px dashed rgba(255,255,255,.20);
      background:rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }

    .deck-wrap.glow{
      box-shadow: 0 0 0 7px color-mix(in srgb, var(--glow) 28%, transparent), 0 0 44px color-mix(in srgb, var(--glow) 35%, transparent);
    }

    .deck-stack{
      width:var(--cardW);
      height:var(--cardH);
      position:relative;
      filter: drop-shadow(0 22px 28px rgba(0,0,0,.45));
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }

    .deck-card{
      position:absolute;
      inset:0;
      border-radius:18px;
      background: linear-gradient(135deg,#2b3f8f,#6aa4ff);
      background-size:cover;
      background-position:center;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 48px rgba(0,0,0,.44);
      overflow:hidden;
    }

    .deck-card:nth-child(1){ transform: translate(0px,0px) rotate(-2deg); }
    .deck-card:nth-child(2){ transform: translate(10px,10px) rotate(1deg); opacity:.96; }
    .deck-card:nth-child(3){ transform: translate(20px,20px) rotate(3deg); opacity:.92; }

    .front-card{
      width:var(--cardW);
      height:var(--cardH);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 26px 62px rgba(0,0,0,.60), 0 0 30px rgba(106,164,255,.18);
      background:
        radial-gradient(980px 560px at 20% 20%, rgba(106,164,255,.20), rgba(0,0,0,0) 60%),
        radial-gradient(820px 600px at 90% 30%, rgba(155,123,255,.18), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      background-size:cover;
      background-position:center;
      overflow:hidden;
      position:relative;
      padding:14px;

      transform-style: preserve-3d;
    }

    .front-card .frame{
      position:absolute;
      inset:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      pointer-events:none;
    }

    .front-card .content{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
    }

    .block{
      padding:12px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }

    .block .label{font-size:12px;color:var(--muted);margin-bottom:8px}

    .block .text{
      font-size:16px;
      line-height:1.35
    }

    .block img{
      max-width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10)
    }

    .block audio{width:100%;}

    .mini-btns{display:flex; gap:8px; flex-wrap:wrap}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .pill.btnlike{cursor:pointer}
    .pill.correct{border-color: rgba(45,210,125,.55); background: rgba(45,210,125,.16)}
    .pill.wrong{border-color: rgba(255,77,77,.55); background: rgba(255,77,77,.12)}

    .block .text.qText{
      font-family: var(--qFont);
      font-size: var(--qSize);
      color: var(--qColor);
      white-space:pre-wrap;
    }

    /* draw anim (–≤–∑—è–ª–∏ –∏–∑ –∫–æ–ª–æ–¥—ã + –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç) */
    .drawAnim{
      animation-duration: var(--drawDur);
      animation-timing-function: cubic-bezier(.22,.85,.24,1);
      animation-fill-mode: both;
      transform-origin: 20% 75%;
      will-change: transform, opacity;
    }
    .drawAnim.flipY{ animation-name: drawFromDeckFlipY; }
    .drawAnim.flipX{ animation-name: drawFromDeckFlipX; }
    .drawAnim.flipDiag{ animation-name: drawFromDeckFlipDiag; }

    @keyframes drawFromDeckFlipY{
      0%{ transform: translateX(-140px) translateY(-40px) scale(.88) rotateY(85deg); opacity:0; }
      55%{ opacity:1; }
      100%{ transform: translateX(0) translateY(0) scale(1) rotateY(0deg); opacity:1; }
    }
    @keyframes drawFromDeckFlipX{
      0%{ transform: translateX(-140px) translateY(-40px) scale(.88) rotateX(85deg); opacity:0; }
      55%{ opacity:1; }
      100%{ transform: translateX(0) translateY(0) scale(1) rotateX(0deg); opacity:1; }
    }
    @keyframes drawFromDeckFlipDiag{
      0%{ transform: translateX(-140px) translateY(-40px) scale(.88) rotateX(65deg) rotateY(55deg); opacity:0; }
      55%{ opacity:1; }
      100%{ transform: translateX(0) translateY(0) scale(1) rotateX(0deg) rotateY(0deg); opacity:1; }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:999999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999998;
      padding:14px;
    }

    .modal{
      width:min(760px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .modal-head .h{font-weight:950}
    .modal-body{padding:14px}

    .modal-foot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .choiceBlock{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    .answerRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }

    .answerRow input[type="text"]{flex:1; min-width:0}

    .radio{
      width:18px;
      height:18px;
      accent-color: var(--accent);
      flex:0 0 auto;
    }

    .promptLine{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .promptLine textarea{flex:1}

    .iconBtn{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      user-select:none;
      transition:background .15s ease, border-color .15s ease, transform .08s ease;
      position:relative;
      overflow:hidden;
    }
    .iconBtn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .iconBtn:active{transform:translateY(1px)}
    .iconBtn input{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    #gameRoot{ display:none; min-height:100vh; padding:14px; }
    #gameShell{ max-width: 1200px; margin: 0 auto; }
  </style>
</head>

<body>
  <div class="app" id="editorRoot">
    <div class="panel settings">
      <div class="panel-header">
        <div class="h">–†–µ–¥–∞–∫—Ç–æ—Ä</div>
        <div class="row" style="margin:0">
          <button class="btn primary" id="btnCopyCode" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        </div>
      </div>

      <div class="errbar" id="errbar"></div>

      <div class="panel-body">

        <div class="section">
          <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞</div>

          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</label>
          <input id="inpTitle" type="text" value="–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É" />

          <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
          <input id="inpSubtitle" type="text" value="–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É" />
        </div>

        <div class="section">
          <div class="title">–†–µ–∂–∏–º</div>

          <label>–ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</label>
          <select id="selOrderMode">
            <option value="random" selected>–†–∞–Ω–¥–æ–º (–ø–µ—Ä–µ–º–µ—à–∞—Ç—å)</option>
            <option value="ordered">–ü–æ –ø–æ—Ä—è–¥–∫—É</option>
          </select>

          <div class="muted" style="margin-top:8px">
            –í–ª–∏—è–µ—Ç –Ω–∞ –∏–≥—Ä—É (iframe).
          </div>
        </div>

        <div class="section">
          <div class="title">–ê–Ω–∏–º–∞—Ü–∏—è –≤—ã—Ç—è–≥–∏–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã</div>

          <div class="toggle" style="margin-top:10px">
            <input id="chkDrawAnim" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ‚Äú–≤–∑—è–ª–∏ –∏–∑ –∫–æ–ª–æ–¥—ã + –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç‚Äù</div>
              <div class="muted">–ö–∞—Ä—Ç–æ—á–∫–∞ ‚Äú–ª–µ—Ç–∏—Ç‚Äù –∏–∑ –∫–æ–ª–æ–¥—ã –∫ –ø–æ–ª—é –∏ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è.</div>
            </div>
          </div>

          <label>–í–∞—Ä–∏–∞–Ω—Ç –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞</label>
          <select id="selFlipType">
            <option value="flipY" selected>Flip Y (–≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ)</option>
            <option value="flipX">Flip X (–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑)</option>
            <option value="flipDiag">–î–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π flip</option>
          </select>

          <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º—Å)</label>
          <input id="inpDrawDur" type="number" min="200" max="2000" step="10" value="650" />

          <div class="muted" style="margin-top:8px">
            –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å ‚Äî –±—É–¥–µ—Ç ‚Äú–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è‚Äù —Å–º–µ–Ω–∞ –∫–∞—Ä—Ç—ã.
          </div>
        </div>

        <div class="section">
          <div class="title">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>

          <label>–®—Ä–∏—Ñ—Ç (5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)</label>
          <select id="selQFont">
            <option value='system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif' selected>System (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
            <option value='Georgia, "Times New Roman", Times, serif'>Georgia (serif)</option>
            <option value='"Trebuchet MS","Segoe UI",Arial,sans-serif'>Trebuchet</option>
            <option value='"Comic Sans MS","Comic Sans",cursive'>Comic Sans</option>
            <option value='"Courier New",Courier,monospace'>Courier (mono)</option>
          </select>

          <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ (px)</label>
          <input id="inpQFontSize" type="number" min="12" max="40" step="1" value="16" />

          <div class="toggle" style="margin-top:10px">
            <input id="chkLatex" type="checkbox" />
            <div>
              <div style="font-weight:900">LaTeX –≤ —Ç–µ–∫—Å—Ç–µ</div>
              <div class="muted">–§–æ—Ä–º—É–ª—ã: <b>$...$</b>, <b>$$...$$</b>, <b>\(...\)</b>, <b>\[...\]</b></div>
            </div>
          </div>

          <label>–¶–≤–µ—Ç —à—Ä–∏—Ñ—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞</label>
          <input id="inpQFontColor" type="color" value="#eaf0ff" />

          <div class="muted" style="margin-top:8px">
            –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ <b>—Ç–µ–∫—Å—Ç–æ–≤—ã–º</b> –≤–æ–ø—Ä–æ—Å–∞–º –≤ –ø—Ä–µ–≤—å—é –∏ –≤ –∏–≥—Ä–µ.
          </div>
        </div>

        <div class="section">
          <div class="title">–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</div>

          <label>–†–µ–∂–∏–º</label>
          <select id="selBgmMode">
            <option value="off" selected>–í—ã–∫–ª—é—á–µ–Ω–æ</option>
            <option value="upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞‚Ä¶</option>
          </select>

          <label>–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω ‚Äú–ó–∞–≥—Ä—É–∑–∏—Ç—å‚Äù)</label>
          <input id="fileBgm" type="file" accept="audio/*" />

          <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
          <input id="inpBgmVol" type="number" min="0" max="1" step="0.05" value="0.6" />

          <div class="muted" style="margin-top:8px">
            –ú—É–∑—ã–∫–∞ <b>—Å—Ç–∞—Ä—Ç—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</b> –≤ –∏–≥—Ä–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ –ø–æ –∫–æ–ª–æ–¥–µ.
          </div>
        </div>

        <div class="section">
          <div class="title">–ó–≤—É–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–æ–ª–æ–¥–µ</div>

          <label>–†–µ–∂–∏–º</label>
          <select id="selClickSound">
            <option value="off" selected>–ë–µ–∑ –∑–≤—É–∫–∞</option>
            <option value="tap">Tap (–ª–µ–≥–∫–∏–π)</option>
            <option value="card">Card Flip (–∫–∞—Ä—Ç–∞)</option>
            <option value="magic">Magic Spark (–º–∞–≥–∏—è)</option>
            <option value="pop">Pop (–ø—Ä–∏—è—Ç–Ω—ã–π)</option>
            <option value="click">Classic Click</option>
          </select>

          <div class="row" style="margin-top:10px">
            <button class="btn small" id="btnTestClickSound" type="button">‚ñ∂Ô∏è –ü—Ä–æ—Å–ª—É—à–∞—Ç—å</button>
            <button class="btn small danger" id="btnStopClickSound" type="button">‚èπ –°—Ç–æ–ø</button>
          </div>

          <div class="muted" style="margin-top:8px">
            –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫–æ–ª–æ–¥–µ (–≤ –∏–≥—Ä–µ) + –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.
          </div>
        </div>

        <div class="section">
          <div class="title">–§–æ–Ω –∏–≥—Ä—ã</div>

          <label>–ü—Ä–µ—Å–µ—Ç —Ñ–æ–Ω–∞</label>
          <select id="selGameBgPreset">
            <option value="aurora" selected>–°–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ</option>
            <option value="nebula">–¢—É–º–∞–Ω–Ω–æ—Å—Ç—å</option>
            <option value="sunset">–ó–∞–∫–∞—Ç–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç</option>
            <option value="minimal">–ú–∏–Ω–∏–º–∞–ª (—Ç—ë–º–Ω—ã–π)</option>
            <option value="upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É‚Ä¶</option>
          </select>

          <label>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω ‚Äú–ó–∞–≥—Ä—É–∑–∏—Ç—å‚Äù)</label>
          <input id="fileGameBg" type="file" accept="image/*" />

          <div class="muted" style="margin-top:8px">
            –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ dataURL. –ï—Å–ª–∏ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã ‚Äî —Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –¥–ª–∏–Ω–Ω–æ–π.
          </div>
        </div>

        <div class="section">
          <div class="title">–§–æ–Ω—ã –∫–∞—Ä—Ç</div>

          <label>–§–æ–Ω –∫–æ–ª–æ–¥—ã (—Ä—É–±–∞—à–∫–∞)</label>
          <input id="fileDeckBg" type="file" accept="image/*" />

          <label style="margin-top:12px">–§–æ–Ω —Ñ—Ä–æ–Ω—Ç–∞ –∫–∞—Ä—Ç—ã (–≤–æ–ø—Ä–æ—Å)</label>
          <input id="fileFrontBg" type="file" accept="image/*" />

          <div class="muted" style="margin-top:8px">
            –ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
          </div>
        </div>

        <div class="section">
          <div class="title">–¢–∞–π–º–µ—Ä</div>

          <div class="toggle">
            <input id="chkTimer" type="checkbox" />
            <div>
              <div style="font-weight:900">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
              <div class="muted">–û—Ç—Å—á—ë—Ç –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç—É. –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ ‚Äî –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥.</div>
            </div>
          </div>

          <label>–ú–∏–Ω—É—Ç –Ω–∞ –∫–∞—Ä—Ç—É</label>
          <input id="inpMinutes" type="number" min="0.1" step="0.1" value="1" />
        </div>

        <div class="section">
          <div class="title">–°–≤–µ—á–µ–Ω–∏–µ –∫–æ–ª–æ–¥—ã</div>

          <div class="toggle">
            <input id="chkGlow" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–°–≤–µ—á–µ–Ω–∏–µ</div>
              <div class="muted">–ú–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –ø–æ–º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç.</div>
            </div>
          </div>

          <label>–¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è</label>
          <input id="inpGlowColor" type="color" value="#6aa4ff" />
        </div>

        <div class="section">
          <div class="title">–í–æ–ø—Ä–æ—Å—ã</div>

          <div class="row">
            <button class="btn primary" id="btnAddQ" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
            <button class="btn" id="btnClearQs" type="button">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="q-list" id="qList" style="margin-top:12px"></div>
        </div>

        <div class="section">
          <div class="title">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
          <div class="muted">
            –ù–∞–∂–º–∏ <b>‚Äúüìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥‚Äù</b> ‚Äî —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è iframe —Å <b>src=...index.html?mode=game#CFG=...</b><br>
            –ï–≥–æ Genially –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞–º–Ω–æ–≥–æ –ª—É—á—à–µ, —á–µ–º srcdoc.
          </div>
        </div>

      </div>
    </div>

    <div class="panel preview">
      <div class="preview-top">
        <div>
          <div class="name">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="hint">–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>
        <div class="muted">–ö–æ–ª–æ–¥–∞ + –∫–∞—Ä—Ç–∞ —Ñ—Ä–æ–Ω—Ç–æ–º –≤–≤–µ—Ä—Ö</div>
      </div>

      <div class="panel-body">
        <div class="preview-stage" id="previewStage">
          <div class="preview-ui">
            <div class="left">
              <div class="title" id="pvTitle">–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É</div>
              <div class="sub" id="pvSubtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É</div>
            </div>

            <div class="right">
              <div class="counter" id="pvCounter">0 / 0</div>
              <div class="progress"><div class="bar" id="pvBar"></div></div>
            </div>
          </div>

          <div class="preview-cards">
            <div class="deck-wrap glow" id="pvDeckWrap">
              <div class="deck-stack" id="pvDeckStack" title="–í –∏–≥—Ä–µ –±—É–¥–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π">
                <div class="deck-card"></div>
                <div class="deck-card"></div>
                <div class="deck-card"></div>
              </div>
            </div>

            <div class="front-card" id="pvFront">
              <div class="frame"></div>
              <div class="content">
                <div class="pill" id="pvTag">–ü—Ä–∏–º–µ—Ä</div>

                <div class="block">
                  <div class="label">–í–æ–ø—Ä–æ—Å</div>
                  <div class="text qText" id="pvPrompt">–ù–∞–∂–º–∏—Ç–µ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å‚Äù –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è.</div>
                </div>

                <div class="block">
                  <div class="label">–û—Ç–≤–µ—Ç</div>
                  <div class="mini-btns" id="pvAnswerArea"></div>
                </div>

                <div class="muted" id="pvTimerHint" style="margin-top:auto; padding:0 2px"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="gameRoot">
    <div id="gameShell"></div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="h" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</div>
        <button class="btn small danger" id="btnCloseModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modal-body">
        <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
        <select id="selAnswerType">
          <option value="choice">–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</option>
          <option value="text">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)</option>
          <option value="free">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)</option>
        </select>

        <label>–í–æ–ø—Ä–æ—Å</label>
        <div class="promptLine">
          <textarea id="inpPromptText" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."></textarea>

          <div class="iconBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π">
            üñºÔ∏è <input id="filePromptImage" type="file" accept="image/*" />
          </div>

          <div class="iconBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å –∞—É–¥–∏–æ">
            üéß <input id="filePromptAudio" type="file" accept="audio/*" />
          </div>
        </div>

        <div class="muted" style="margin-top:6px" id="promptModeHint">
          –ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É/–∞—É–¥–∏–æ (–∏–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞).
        </div>

        <div id="choiceWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–û—Ç–≤–µ—Ç—ã (–≤—ã–±–æ—Ä)</div>
          <div class="muted">–û—Ç–º–µ—Ç—å—Ç–µ ‚Äú–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç‚Äù –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.</div>
          <div id="choiceList"></div>
          <button class="btn small" id="btnAddChoice" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)</div>
          <div class="muted">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ò–≥—Ä–∞ –ø—Ä–∏–º–µ—Ç –ª—é–±–æ–π –∏–∑ –Ω–∏—Ö.</div>
          <div id="textAnswers"></div>
          <button class="btn small" id="btnAddTextAnswer" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="freeWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥</div>
          <div class="muted">–ò–≥—Ä–∞ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç. –ò–≥—Ä–æ–∫ –≤–≤–æ–¥–∏—Ç –∏ –Ω–∞–∂–∏–º–∞–µ—Ç ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù.</div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnPreviewDraft" type="button">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é</button>
        <button class="btn primary" id="btnSaveQ" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

<script>
(() => {
  "use strict";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "editor").toLowerCase();

  const errbar = document.getElementById("errbar");
  function showErr(msg){
    if (!errbar) return;
    errbar.classList.add("show");
    errbar.textContent = "–û—à–∏–±–∫–∞ JS:\n" + msg;
  }
  window.addEventListener("error", (e) => {
    const m = e?.error?.stack || e?.message || String(e);
    showErr(m);
  });
  window.addEventListener("unhandledrejection", (e) => {
    const m = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
    showErr(m);
  });

  const $ = (id)=>document.getElementById(id);

  function uid(){
    return "q_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
  }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function toast(msg){
    const t = $("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function presetCss(preset, uploadDataUrl){
    if (preset === "upload" && uploadDataUrl){
      return `radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.16) 0%, rgba(0,0,0,0) 58%),
              radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.12) 0%, rgba(0,0,0,0) 62%),
              linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.65)),
              url("${uploadDataUrl}")`;
    }

    if (preset === "nebula"){
      return `radial-gradient(1200px 800px at 20% 20%, rgba(255,120,180,.16) 0%, rgba(0,0,0,0) 60%),
              radial-gradient(900px 700px at 80% 15%, rgba(106,164,255,.16) 0%, rgba(0,0,0,0) 62%),
              radial-gradient(900px 700px at 50% 110%, rgba(155,123,255,.14) 0%, rgba(0,0,0,0) 60%),
              linear-gradient(180deg, rgba(10,12,32,.75), rgba(5,8,22,1))`;
    }

    if (preset === "sunset"){
      return `radial-gradient(1100px 700px at 20% 10%, rgba(255,170,80,.16) 0%, rgba(0,0,0,0) 60%),
              radial-gradient(900px 700px at 80% 25%, rgba(255,80,140,.14) 0%, rgba(0,0,0,0) 60%),
              radial-gradient(900px 700px at 50% 110%, rgba(106,164,255,.12) 0%, rgba(0,0,0,0) 58%),
              linear-gradient(180deg, rgba(12,10,26,.70), rgba(5,8,22,1))`;
    }

    if (preset === "minimal"){
      return `radial-gradient(900px 600px at 20% 15%, rgba(255,255,255,.06) 0%, rgba(0,0,0,0) 55%),
              linear-gradient(180deg, rgba(10,14,40,.55), rgba(5,8,22,1))`;
    }

    return `radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.20) 0%, rgba(5,8,22,0) 58%),
            radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.16) 0%, rgba(5,8,22,0) 62%),
            radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.14) 0%, rgba(5,8,22,0) 58%),
            radial-gradient(900px 600px at 50% 55%, rgba(255,255,255,.06) 0%, rgba(5,8,22,0) 55%),
            linear-gradient(180deg, rgba(10,14,40,.65), rgba(5,8,22,1))`;
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}

    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "0";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.pointerEvents = "none";
      ta.style.zIndex = "-1";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  // ===== HASH CFG (–¥–ª—è Genially) =====
  function b64EncodeUnicode(str){
    return btoa(unescape(encodeURIComponent(str)));
  }
  function b64DecodeUnicode(str){
    return decodeURIComponent(escape(atob(str)));
  }
  function baseUrlNoQueryHash(){
    return location.origin + location.pathname; // https://.../index.html
  }
  function encodeCfgToHash(cfg){
    const json = JSON.stringify(cfg);
    const b64 = b64EncodeUnicode(json);
    return "CFG=" + b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=",".");
  }
  function decodeCfgFromHash(){
    const h = (location.hash || "").replace(/^#/,"");
    if (!h.startsWith("CFG=")) return null;
    let b = h.slice(4).replaceAll("-","+").replaceAll("_","/").replaceAll(".","=");
    try{
      const json = b64DecodeUnicode(b);
      return JSON.parse(json);
    }catch(e){
      return null;
    }
  }

  function renderLatexInto(el, latexEnabled){
    if (!latexEnabled) return;
    if (!el) return;
    if (typeof window.renderMathInElement !== "function") return;

    try{
      window.renderMathInElement(el, {
        delimiters: [
          {left:"$$", right:"$$", display:true},
          {left:"$", right:"$", display:false},
          {left:"\\(", right:"\\)", display:false},
          {left:"\\[", right:"\\]", display:true}
        ],
        throwOnError: false
      });
    }catch(e){}
  }

  // ===== Click sound (preview + game) =====
  let __previewClickSound = null;

  function createClickSoundPlayer(type){
    if (!type || type === "off") return null;

    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const out = ctx.createGain();
    out.connect(ctx.destination);
    out.gain.value = 0.8;

    function play(){
      const now = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(out);

      gain.gain.setValueAtTime(0.0001, now);

      if (type === "tap"){
        osc.type = "sine";
        osc.frequency.setValueAtTime(520, now);
        gain.gain.exponentialRampToValueAtTime(0.22, now + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
        osc.start(now); osc.stop(now + 0.10);
        return;
      }

      if (type === "card"){
        osc.type = "triangle";
        osc.frequency.setValueAtTime(240, now);
        gain.gain.exponentialRampToValueAtTime(0.26, now + 0.008);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.14);
        osc.start(now); osc.stop(now + 0.15);
        return;
      }

      if (type === "magic"){
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, now);
        osc.frequency.exponentialRampToValueAtTime(1400, now + 0.12);
        gain.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
        osc.start(now); osc.stop(now + 0.19);
        return;
      }

      if (type === "pop"){
        osc.type = "square";
        osc.frequency.setValueAtTime(300, now);
        gain.gain.exponentialRampToValueAtTime(0.16, now + 0.008);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.11);
        osc.start(now); osc.stop(now + 0.12);
        return;
      }

      // click
      osc.type = "square";
      osc.frequency.setValueAtTime(1200, now);
      gain.gain.exponentialRampToValueAtTime(0.12, now + 0.004);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.06);
      osc.start(now); osc.stop(now + 0.07);
    }

    function stop(){
      try{ ctx.close(); }catch(e){}
    }

    return { ctx, play, stop };
  }

  function stopPreviewClickSound(){
    if (__previewClickSound){
      try{ __previewClickSound.stop(); }catch(e){}
      __previewClickSound = null;
    }
  }

  function playPreviewClickSound(type){
    stopPreviewClickSound();
    const p = createClickSoundPlayer(type);
    if (!p) return;
    __previewClickSound = p;
    try{
      if (p.ctx.state === "suspended") p.ctx.resume();
      p.play();
    }catch(e){}
  }

  // ===== GAME (–±–µ–∑ srcdoc, –ø—Ä–æ—Å—Ç–æ –ø–æ URL+hash) =====
  function runGame(shell, cfg){
    const meta = cfg.meta || {title:"–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É", subtitle:"–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É"};
    const timer = cfg.timer || {enabled:false, minutes:1};
    const glow = cfg.glow || {enabled:true, color:"#6aa4ff"};
    const questions = Array.isArray(cfg.questions) ? cfg.questions.slice() : [];
    const qStyle = cfg.qStyle || {fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif', fontSize:16, color:'#eaf0ff'};
    const bgm = cfg.bgm || {mode:"off", dataUrl:"", volume:0.6};
    const clickSoundType = cfg.clickSound || "off";

    const orderMode = cfg.orderMode || "random";
    const drawAnim = cfg.drawAnim || {enabled:true, flipType:"flipY", durationMs:650};

    document.documentElement.style.setProperty("--qFont", qStyle.fontFamily || 'system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif');
    document.documentElement.style.setProperty("--qSize", Math.max(12, Math.min(40, Number(qStyle.fontSize || 16))) + "px");
    document.documentElement.style.setProperty("--qColor", qStyle.color || "#eaf0ff");
    document.documentElement.style.setProperty("--drawDur", Math.max(200, Math.min(2000, Number(drawAnim.durationMs || 650))) + "ms");

    // order
    const order = questions.slice();
    if (orderMode === "random"){
      for(let i=order.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [order[i], order[j]] = [order[j], order[i]];
      }
    }

    shell.innerHTML = `
      <div class="panel">
        <div class="panel-body" style="padding:0">
          <div class="preview-stage" id="gStage">
            <div class="preview-ui">
              <div class="left">
                <div class="title" id="gTitle"></div>
                <div class="sub" id="gSub"></div>
              </div>
              <div class="right">
                <div class="counter" id="gCounter"></div>
                <div class="progress"><div class="bar" id="gBar"></div></div>
                <div class="pill" id="gTimerPill" style="display:none"></div>
              </div>
            </div>

            <div class="preview-cards">
              <div class="deck-wrap" id="gDeckWrap">
                <div class="deck-stack" id="gDeck" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É">
                  <div class="deck-card"></div>
                  <div class="deck-card"></div>
                  <div class="deck-card"></div>
                </div>
              </div>

              <div class="front-card" id="gFront">
                <div class="frame"></div>
                <div class="content">
                  <div class="pill" id="gTag">–°—Ç–∞—Ä—Ç</div>

                  <div class="block">
                    <div class="label">–í–æ–ø—Ä–æ—Å</div>
                    <div class="text qText" id="gPrompt"></div>
                  </div>

                  <div class="block">
                    <div class="label">–û—Ç–≤–µ—Ç</div>
                    <div class="mini-btns" id="gAnswers"></div>
                  </div>

                  <div class="muted" id="gHint" style="margin-top:auto; padding:0 2px"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;

    const stage = shell.querySelector("#gStage");
    const deckWrap = shell.querySelector("#gDeckWrap");
    const deck = shell.querySelector("#gDeck");
    const front = shell.querySelector("#gFront");
    const gTitle = shell.querySelector("#gTitle");
    const gSub = shell.querySelector("#gSub");
    const gCounter = shell.querySelector("#gCounter");
    const gBar = shell.querySelector("#gBar");
    const gTimerPill = shell.querySelector("#gTimerPill");
    const gTag = shell.querySelector("#gTag");
    const gPrompt = shell.querySelector("#gPrompt");
    const gAnswers = shell.querySelector("#gAnswers");
    const gHint = shell.querySelector("#gHint");

    stage.style.backgroundImage = presetCss(cfg.gameBg?.preset || "aurora", cfg.gameBg?.uploadDataUrl || "");
    stage.style.backgroundSize = ((cfg.gameBg?.preset || "") === "upload") ? "cover" : "auto";
    stage.style.backgroundPosition = ((cfg.gameBg?.preset || "") === "upload") ? "center" : "initial";

    if (cfg.deckBackUrl){
      deck.querySelectorAll(".deck-card").forEach(c=>{
        c.style.backgroundImage = `url("${cfg.deckBackUrl}")`;
        c.style.backgroundSize = "cover";
        c.style.backgroundPosition = "center";
      });
    }

    if (cfg.frontBgUrl){
      front.style.backgroundImage = `url("${cfg.frontBgUrl}")`;
      front.style.backgroundSize = "cover";
      front.style.backgroundPosition = "center";
    }

    document.documentElement.style.setProperty("--glow", glow.color || "#6aa4ff");
    deckWrap.classList.toggle("glow", !!glow.enabled);

    gTitle.textContent = meta.title || "–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É";
    gSub.textContent = meta.subtitle || "";

    function applyDrawAnim(){
      front.classList.remove("drawAnim","flipY","flipX","flipDiag");
      if (!drawAnim?.enabled) return;
      front.classList.add("drawAnim");
      front.classList.add(drawAnim.flipType || "flipY");
    }

    let bgmAudio = null;
    function initBgm(){
      if (!bgm || bgm.mode !== "upload" || !bgm.dataUrl) return;
      bgmAudio = document.createElement("audio");
      bgmAudio.src = bgm.dataUrl;
      bgmAudio.loop = true;
      bgmAudio.preload = "auto";
      bgmAudio.volume = Math.max(0, Math.min(1, Number(bgm.volume ?? 0.6)));
      bgmAudio.style.display = "none";
      document.body.appendChild(bgmAudio);
    }

    let startedBgm = false;
    function startBgmIfNeeded(){
      if (startedBgm) return;
      startedBgm = true;
      if (!bgmAudio) return;
      bgmAudio.play().catch(()=>{});
    }
    initBgm();

    const clickSound = createClickSoundPlayer(clickSoundType);

    let idx = -1;
    let lock = false;
    let answered = false;
    let timerId = null;
    let endsAt = 0;

    function setFrontVisible(v){ front.style.display = v ? "" : "none"; }
    setFrontVisible(false);

    function setProgress(){
      const total = order.length;
      const shown = Math.max(0, idx+1);
      gCounter.textContent = `${shown} / ${total}`;
      gBar.style.width = total ? `${(shown/total)*100}%` : "0%";
    }

    function clearTimer(){
      if (timerId){ clearInterval(timerId); timerId = null; }
      gTimerPill.style.display = "none";
    }

    function startTimer(){
      clearTimer();
      if (!timer?.enabled) return;
      const minutes = Math.max(0, Number(timer.minutes || 0));
      if (!minutes) return;
      const ms = Math.floor(minutes * 60 * 1000);
      endsAt = Date.now() + ms;
      gTimerPill.style.display = "inline-flex";
      tickTimer();
      timerId = setInterval(tickTimer, 250);
    }

    function tickTimer(){
      const left = Math.max(0, endsAt - Date.now());
      const sec = Math.ceil(left / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      gTimerPill.textContent = `‚è≥ ${m}:${String(s).padStart(2,"0")}`;
      if (left <= 0){
        clearTimer();
        nextCard(true);
      }
    }

    function renderCard(q){
      answered = false;
      gAnswers.innerHTML = "";
      gPrompt.innerHTML = "";

      if (!q){
        setFrontVisible(true);
        applyDrawAnim();
        gTag.textContent = "–§–∏–Ω–∏—à";
        gPrompt.textContent = "–ö–∞—Ä—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å ‚úÖ";
        gHint.textContent = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.";
        return;
      }

      setFrontVisible(true);
      applyDrawAnim();

      gTag.textContent =
        (q.answer?.type === "choice") ? "–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞" :
        (q.answer?.type === "text") ? "–° –≤–≤–æ–¥–æ–º (–ø—Ä–æ–≤–µ—Ä–∫–∞)" :
        "–° –≤–≤–æ–¥–æ–º (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)";

      if (q.prompt?.mode === "image"){
        const img = document.createElement("img");
        img.alt = "–í–æ–ø—Ä–æ—Å";
        img.src = q.prompt.value || "";
        gPrompt.appendChild(img);
      }
      else if (q.prompt?.mode === "audio"){
        const aud = document.createElement("audio");
        aud.controls = true;
        aud.src = q.prompt.value || "";
        gPrompt.appendChild(aud);
      }
      else{
        gPrompt.textContent = q.prompt?.value || "";
        renderLatexInto(gPrompt, !!cfg.latex);
      }

      if (q.answer?.type === "choice"){
        const opts = Array.isArray(q.answer.options) ? q.answer.options : [];
        const correctIndex = Number.isFinite(q.answer.correctIndex) ? q.answer.correctIndex : 0;

        opts.forEach((txt, i)=>{
          const b = document.createElement("span");
          b.className = "pill btnlike";
          b.textContent = txt || `–í–∞—Ä–∏–∞–Ω—Ç ${i+1}`;

          b.onclick = (e)=>{
            e.stopPropagation();
            if (answered) return;
            answered = true;
            const ok = (i === correctIndex);
            b.classList.add(ok ? "correct" : "wrong");

            [...gAnswers.querySelectorAll(".pill.btnlike")].forEach((el, j)=>{
              if (j === correctIndex) el.classList.add("correct");
            });

            gHint.textContent = ok
              ? "–í–µ—Ä–Ω–æ ‚úÖ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã."
              : "–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã.";
          };

          gAnswers.appendChild(b);
        });

        gHint.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.";
      }

      else if (q.answer?.type === "text"){
        const inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶";
        inp.style.flex = "1";
        inp.style.minWidth = "0";

        const btn = document.createElement("button");
        btn.className = "btn small primary";
        btn.type = "button";
        btn.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";

        const accepts = (q.answer?.accepts || []).map(x=>String(x||"").trim().toLowerCase()).filter(Boolean);

        function check(e){
          if (e) e.stopPropagation();
          if (answered) return;
          const v = String(inp.value || "").trim().toLowerCase();
          if (!v){ toast("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"); return; }

          answered = true;
          const ok = accepts.includes(v);

          gHint.textContent = ok
            ? "–í–µ—Ä–Ω–æ ‚úÖ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã."
            : "–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã.";

          inp.disabled = true;
          btn.disabled = true;

          const badge = document.createElement("span");
          badge.className = "pill " + (ok ? "correct" : "wrong");
          badge.textContent = ok ? "‚úÖ –í–µ—Ä–Ω–æ" : "‚ùå –ù–µ–≤–µ—Ä–Ω–æ";
          gAnswers.appendChild(badge);
        }

        btn.onclick = check;

        inp.addEventListener("keydown", (e)=>{ if(e.key === "Enter") check(e); });
        inp.addEventListener("click",(e)=>e.stopPropagation());
        btn.addEventListener("click",(e)=>e.stopPropagation());

        gAnswers.appendChild(inp);
        gAnswers.appendChild(btn);

        gHint.textContent = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.";
      }

      else{
        const inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶";
        inp.style.flex = "1";
        inp.style.minWidth = "0";

        const btn = document.createElement("button");
        btn.className = "btn small primary";
        btn.type = "button";
        btn.textContent = "–ì–æ—Ç–æ–≤–æ";

        function done(e){
          if (e) e.stopPropagation();
          if (answered) return;
          const v = String(inp.value || "").trim();
          if (!v){ toast("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"); return; }

          answered = true;
          inp.disabled = true;
          btn.disabled = true;

          const badge = document.createElement("span");
          badge.className = "pill correct";
          badge.textContent = "‚úÖ –ü—Ä–∏–Ω—è—Ç–æ";
          gAnswers.appendChild(badge);

          gHint.textContent = "–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç ‚úÖ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç—ã.";
        }

        btn.onclick = done;

        inp.addEventListener("keydown", (e)=>{ if(e.key === "Enter") done(e); });
        inp.addEventListener("click",(e)=>e.stopPropagation());
        btn.addEventListener("click",(e)=>e.stopPropagation());

        gAnswers.appendChild(inp);
        gAnswers.appendChild(btn);

        gHint.textContent = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.";
      }
    }

    function nextCard(fromTimer=false){
      startBgmIfNeeded();

      if (clickSound){
        try{
          if (clickSound.ctx.state === "suspended") clickSound.ctx.resume();
          clickSound.play();
        }catch(e){}
      }

      if (lock) return;
      lock = true;
      setTimeout(()=>{ lock = false; }, 180);

      if (idx >= order.length - 1){
        idx = -1;
        setProgress();
        clearTimer();
        setFrontVisible(false);
        gHint.textContent = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
        return;
      }

      idx++;
      setProgress();
      renderCard(order[idx] || null);
      clearTimer();
      startTimer();

      if(fromTimer){ toast("‚è± –í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî —Å–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–∞"); }
    }

    setProgress();
    gHint.textContent = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
    gTag.textContent = "–°—Ç–∞—Ä—Ç";

    deck.addEventListener("click", ()=> nextCard(false));
    deck.addEventListener("keydown", (e)=>{ if(e.key === "Enter" || e.key === " ") nextCard(false); });
    deck.tabIndex = 0;
  }

  // ====== MODE: GAME ======
  if (mode === "game"){
    document.body.classList.add("gameOnly");
    const editorRoot = $("editorRoot");
    const gameRoot = $("gameRoot");
    const shell = $("gameShell");
    if (editorRoot) editorRoot.style.display = "none";
    if (gameRoot) gameRoot.style.display = "block";

    const cfg = decodeCfgFromHash();
    if (!cfg){
      shell.innerHTML = `
        <div class="panel" style="max-width:860px;margin:0 auto">
          <div class="panel-header"><div class="h">–ò–≥—Ä–∞</div></div>
          <div class="panel-body">
            <div class="muted">–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Å—Å—ã–ª–∫–µ (#CFG=...). –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–¥ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.</div>
          </div>
        </div>
      `;
      return;
    }
    runGame(shell, cfg);
    return;
  }

  // ====== EDITOR ======
  const Editor = {
    meta: { title:"–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É", subtitle:"–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–ª–æ–¥—É, —á—Ç–æ–±—ã –≤—ã—Ç—è–Ω—É—Ç—å –∫–∞—Ä—Ç—É" },
    orderMode: "random",
    drawAnim: { enabled: true, flipType: "flipY", durationMs: 650 },

    gameBg: { preset:"aurora", uploadDataUrl:"" },
    deckBackUrl: "",
    frontBgUrl: "",
    timer: { enabled:false, minutes: 1 },
    glow: { enabled:true, color:"#6aa4ff" },
    qStyle: { fontFamily: 'system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif', fontSize: 16, color: '#eaf0ff' },
    latex: false,
    bgm: { mode: "off", dataUrl: "", volume: 0.6 },
    clickSound: "off",
    questions: [],
    draft: null,
    editingId: null
  };

  function applyQuestionStyle(){
    document.documentElement.style.setProperty("--qFont", Editor.qStyle.fontFamily || 'system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif');
    document.documentElement.style.setProperty("--qSize", Math.max(12, Math.min(40, Number(Editor.qStyle.fontSize || 16))) + "px");
    document.documentElement.style.setProperty("--qColor", Editor.qStyle.color || "#eaf0ff");
    document.documentElement.style.setProperty("--drawDur", Math.max(200, Math.min(2000, Number(Editor.drawAnim.durationMs || 650))) + "ms");
  }

  function applyPreviewBackgrounds(){
    const stage = $("previewStage");
    stage.style.backgroundImage = presetCss(Editor.gameBg.preset, Editor.gameBg.uploadDataUrl);
    stage.style.backgroundSize = (Editor.gameBg.preset === "upload") ? "cover" : "auto";
    stage.style.backgroundPosition = (Editor.gameBg.preset === "upload") ? "center" : "initial";

    const deckCards = $("pvDeckStack").querySelectorAll(".deck-card");
    deckCards.forEach(c=>{
      if (Editor.deckBackUrl){
        c.style.backgroundImage = `url("${Editor.deckBackUrl}")`;
        c.style.backgroundSize = "cover";
        c.style.backgroundPosition = "center";
      } else {
        c.style.backgroundImage = "";
      }
    });

    const front = $("pvFront");
    if (Editor.frontBgUrl){
      front.style.backgroundImage = `url("${Editor.frontBgUrl}")`;
      front.style.backgroundSize = "cover";
      front.style.backgroundPosition = "center";
    } else {
      front.style.backgroundImage = "";
    }

    document.documentElement.style.setProperty("--glow", Editor.glow.color || "#6aa4ff");
    $("pvDeckWrap").classList.toggle("glow", !!Editor.glow.enabled);
  }

  function updatePreviewBasics(){
    $("pvTitle").textContent = Editor.meta.title || "–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É";
    $("pvSubtitle").textContent = Editor.meta.subtitle || "";

    const total = Editor.questions.length;
    const shown = total ? 1 : 0;

    $("pvCounter").textContent = `${shown} / ${total}`;
    $("pvBar").style.width = total ? `${(shown/total)*100}%` : "0%";

    $("pvTimerHint").textContent = Editor.timer.enabled
      ? `–¢–∞–π–º–µ—Ä: ${Editor.timer.minutes} –º–∏–Ω. –Ω–∞ –∫–∞—Ä—Ç—É`
      : "–¢–∞–π–º–µ—Ä: –≤—ã–∫–ª—é—á–µ–Ω";

    applyQuestionStyle();
    applyPreviewBackgrounds();
  }

  function applyPreviewDrawAnim(){
    const front = $("pvFront");
    front.classList.remove("drawAnim","flipY","flipX","flipDiag");
    if (!Editor.drawAnim.enabled) return;
    front.classList.add("drawAnim");
    front.classList.add(Editor.drawAnim.flipType || "flipY");
  }

  function renderPreviewCardFromQuestion(q){
    const tag = $("pvTag");
    const promptWrap = $("pvPrompt");
    const area = $("pvAnswerArea");

    area.innerHTML = "";
    promptWrap.innerHTML = "";

    applyPreviewDrawAnim();

    if (!q){
      tag.textContent = "–ü—Ä–∏–º–µ—Ä";
      promptWrap.textContent = "–ù–∞–∂–º–∏—Ç–µ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å‚Äù –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è.";
      return;
    }

    tag.textContent =
      (q.answer.type === "choice") ? "–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞" :
      (q.answer.type === "text") ? "–° –≤–≤–æ–¥–æ–º (–ø—Ä–æ–≤–µ—Ä–∫–∞)" :
      "–° –≤–≤–æ–¥–æ–º (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)";

    if (q.prompt.mode === "image"){
      const img = document.createElement("img");
      img.alt = "–í–æ–ø—Ä–æ—Å";
      img.src = q.prompt.value || "";
      promptWrap.appendChild(img);
    }
    else if (q.prompt.mode === "audio"){
      const audio = document.createElement("audio");
      audio.controls = true;
      audio.src = q.prompt.value || "";
      promptWrap.appendChild(audio);
    }
    else{
      promptWrap.textContent = q.prompt.value || "";
      renderLatexInto(promptWrap, Editor.latex);
    }

    if (q.answer.type === "choice"){
      (q.answer.options || []).forEach((opt, idx)=>{
        const p = document.createElement("span");
        p.className = "pill";
        p.textContent = opt || `–í–∞—Ä–∏–∞–Ω—Ç ${idx+1}`;
        area.appendChild(p);
      });
    }
    else if (q.answer.type === "text") {
      const accepts = (q.answer.accepts || []).filter(Boolean);
      const m = document.createElement("div");
      m.className = "muted";
      m.textContent = accepts.length ? `–ü—Ä–∏–º–µ—Ä –≤–µ—Ä–Ω–æ–≥–æ: ‚Äú${accepts[0]}‚Äù` : "–î–æ–±–∞–≤—å—Ç–µ –≤–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã‚Ä¶";
      area.appendChild(m);
    }
    else {
      const m = document.createElement("div");
      m.className = "muted";
      m.textContent = "–°–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)";
      area.appendChild(m);
    }
  }

  function qSummary(q){
    const p =
      q.prompt.mode === "image" ? "[–∫–∞—Ä—Ç–∏–Ω–∫–∞]" :
      q.prompt.mode === "audio" ? "[–∞—É–¥–∏–æ]" :
      (q.prompt.value || "");

    const short = p.length > 48 ? p.slice(0,48) + "‚Ä¶" : p;

    const type =
      q.answer.type === "choice" ? "–í—ã–±–æ—Ä" :
      q.answer.type === "text" ? "–í–≤–æ–¥ (–ø—Ä–æ–≤–µ—Ä–∫–∞)" :
      "–í–≤–æ–¥ (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏)";

    return { title: short || "(–ø—É—Å—Ç–æ)", sub: type };
  }

  function renderQuestionList(){
    const list = $("qList");
    list.innerHTML = "";

    if (Editor.questions.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å‚Äù.";
      list.appendChild(empty);

      updatePreviewBasics();
      renderPreviewCardFromQuestion(null);
      return;
    }

    Editor.questions.forEach((q, i)=>{
      const wrap = document.createElement("div");
      wrap.className = "q-item";

      const meta = document.createElement("div");
      meta.className = "meta";

      const s = qSummary(q);
      meta.innerHTML = `<div class="t">${escapeHtml(String(i+1)+". "+s.title)}</div>
                        <div class="s">${escapeHtml(s.sub)}</div>`;

      const btns = document.createElement("div");
      btns.style.display="flex";
      btns.style.gap="8px";
      btns.style.flexWrap="wrap";
      btns.style.justifyContent="flex-end";

      const bPrev = document.createElement("button");
      bPrev.className = "btn small";
      bPrev.textContent = "üëÅ";
      bPrev.title = "–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é";
      bPrev.type="button";
      bPrev.onclick = ()=>{
        renderPreviewCardFromQuestion(q);
        toast("–ü–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–≤—å—é");
      };

      const bEdit = document.createElement("button");
      bEdit.className = "btn small";
      bEdit.textContent = "‚úèÔ∏è";
      bEdit.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      bEdit.type="button";
      bEdit.onclick = ()=>{
        openQuestionModal(q);
      };

      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.textContent = "üóë";
      bDel.title = "–£–¥–∞–ª–∏—Ç—å";
      bDel.type="button";
      bDel.onclick = ()=>{
        Editor.questions = Editor.questions.filter(x=>x.id!==q.id);
        renderQuestionList();
        updatePreviewBasics();
        toast("–£–¥–∞–ª–µ–Ω–æ");
      };

      btns.appendChild(bPrev);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);

      wrap.appendChild(meta);
      wrap.appendChild(btns);

      list.appendChild(wrap);
    });

    updatePreviewBasics();
    renderPreviewCardFromQuestion(Editor.questions[0] || null);
  }

  function showModal(){
    const b = $("modalBackdrop");
    b.style.display = "flex";
    b.setAttribute("aria-hidden","false");
  }

  function hideModal(){
    const b = $("modalBackdrop");
    b.style.display = "none";
    b.setAttribute("aria-hidden","true");
  }

  function updatePromptHint(){
    const q = Editor.draft;
    if (!q) return;

    $("promptModeHint").textContent =
      (q.prompt.mode === "image") ? "–°–µ–π—á–∞—Å –≤–æ–ø—Ä–æ—Å ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞. –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å, —Å–Ω–æ–≤–∞ –Ω–∞–∂–∞–≤ –Ω–∞ üñºÔ∏è." :
      (q.prompt.mode === "audio") ? "–°–µ–π—á–∞—Å –≤–æ–ø—Ä–æ—Å ‚Äî –∞—É–¥–∏–æ. –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å, —Å–Ω–æ–≤–∞ –Ω–∞–∂–∞–≤ –Ω–∞ üéß." :
      "–ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É/–∞—É–¥–∏–æ (–∏–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞).";
  }

  function syncAnswerUI(){
    const type = $("selAnswerType").value;
    $("choiceWrap").style.display = (type === "choice") ? "block" : "none";
    $("textWrap").style.display = (type === "text") ? "block" : "none";
    $("freeWrap").style.display = (type === "free") ? "block" : "none";
  }

  function renderChoiceUI(){
    const list = $("choiceList");
    list.innerHTML = "";

    const q = Editor.draft;
    if (!q) return;

    if (!q.answer.options) q.answer.options = ["",""];
    if (typeof q.answer.correctIndex !== "number") q.answer.correctIndex = 0;

    q.answer.options.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const radio = document.createElement("input");
      radio.className = "radio";
      radio.type = "radio";
      radio.name = "correctChoice";
      radio.checked = (q.answer.correctIndex === idx);
      radio.onchange = ()=>{
        q.answer.correctIndex = idx;
        renderChoiceUI();
      };

      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = (idx === q.answer.correctIndex) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : `–í–∞—Ä–∏–∞–Ω—Ç ${idx+1}`;
      inp.value = val || "";
      inp.oninput = ()=>{
        q.answer.options[idx] = inp.value;
      };

      const del = document.createElement("button");
      del.className = "btn small danger";
      del.textContent = "‚úñ";
      del.type="button";
      del.onclick = ()=>{
        q.answer.options.splice(idx,1);
        if (q.answer.options.length < 2) q.answer.options.push("");
        if (q.answer.correctIndex >= q.answer.options.length) q.answer.correctIndex = q.answer.options.length-1;
        renderChoiceUI();
      };

      row.appendChild(radio);
      row.appendChild(inp);
      row.appendChild(del);

      list.appendChild(row);
    });
  }

  function renderTextAnswersUI(){
    const list = $("textAnswers");
    list.innerHTML = "";

    const q = Editor.draft;
    if (!q) return;

    if (!q.answer.accepts) q.answer.accepts = [""];

    q.answer.accepts.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = (idx === 0) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : `–í–µ—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ${idx+1}`;
      inp.value = val || "";
      inp.oninput = ()=>{
        q.answer.accepts[idx] = inp.value;
      };

      const del = document.createElement("button");
      del.className = "btn small danger";
      del.textContent = "‚úñ";
      del.type="button";
      del.onclick = ()=>{
        q.answer.accepts.splice(idx,1);
        if (q.answer.accepts.length === 0) q.answer.accepts.push("");
        renderTextAnswersUI();
      };

      row.appendChild(inp);
      row.appendChild(del);

      list.appendChild(row);
    });
  }

  function openQuestionModal(existing=null){
    if (existing){
      Editor.draft = deepClone(existing);
      Editor.editingId = existing.id;
      $("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å";
    } else {
      Editor.draft = {
        id: uid(),
        prompt: { mode:"text", value:"" },
        answer: { type:"choice", options:["",""], correctIndex:0 }
      };
      Editor.editingId = null;
      $("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å";
    }

    const q = Editor.draft;

    $("selAnswerType").value = q.answer?.type || "choice";
    $("inpPromptText").value = (q.prompt?.mode === "text") ? (q.prompt.value || "") : "";

    $("filePromptImage").value = "";
    $("filePromptAudio").value = "";

    syncAnswerUI();

    if ($("selAnswerType").value === "choice"){
      if (!q.answer.options) q.answer.options = ["",""];
      if (typeof q.answer.correctIndex !== "number") q.answer.correctIndex = 0;
      renderChoiceUI();
    }
    else if ($("selAnswerType").value === "text"){
      if (!q.answer.accepts) q.answer.accepts = [""];
      renderTextAnswersUI();
    }

    updatePromptHint();
    showModal();

    setTimeout(()=>{ $("inpPromptText").focus(); }, 30);
  }

  function draftFromControls(){
    const q = Editor.draft;
    if (!q) return null;

    const ansType = $("selAnswerType").value;

    if (q.prompt.mode !== "image" && q.prompt.mode !== "audio"){
      q.prompt.mode = "text";
      q.prompt.value = $("inpPromptText").value || "";
    }

    if (ansType === "choice"){
      q.answer.type = "choice";
      q.answer.options = (q.answer.options || []).map(x=>String(x||""));
      q.answer.correctIndex = Number.isFinite(q.answer.correctIndex) ? q.answer.correctIndex : 0;
    }
    else if (ansType === "text") {
      q.answer = { type:"text", accepts: (q.answer.accepts || [""]).map(x=>String(x||"")) };
    }
    else {
      q.answer = { type:"free" };
    }

    return q;
  }

  // ==== –±–∏–Ω–¥–∏–Ω–≥–∏ ====
  $("inpTitle").addEventListener("input", ()=>{
    Editor.meta.title = $("inpTitle").value;
    updatePreviewBasics();
  });

  $("inpSubtitle").addEventListener("input", ()=>{
    Editor.meta.subtitle = $("inpSubtitle").value;
    updatePreviewBasics();
  });

  $("selOrderMode").addEventListener("change", ()=>{
    Editor.orderMode = $("selOrderMode").value || "random";
    toast(Editor.orderMode === "random" ? "–†–∞–Ω–¥–æ–º –≤–∫–ª—é—á—ë–Ω" : "–ü–æ –ø–æ—Ä—è–¥–∫—É");
  });

  $("chkDrawAnim").addEventListener("change", ()=>{
    Editor.drawAnim.enabled = $("chkDrawAnim").checked;
    applyPreviewDrawAnim();
  });

  $("selFlipType").addEventListener("change", ()=>{
    Editor.drawAnim.flipType = $("selFlipType").value || "flipY";
    applyPreviewDrawAnim();
  });

  $("inpDrawDur").addEventListener("input", ()=>{
    const v = Number($("inpDrawDur").value || 650);
    Editor.drawAnim.durationMs = Math.max(200, Math.min(2000, v));
    applyQuestionStyle();
    applyPreviewDrawAnim();
  });

  $("selQFont").addEventListener("change", ()=>{
    Editor.qStyle.fontFamily = $("selQFont").value;
    updatePreviewBasics();
    renderPreviewCardFromQuestion(Editor.questions[0] || null);
  });

  $("inpQFontSize").addEventListener("input", ()=>{
    Editor.qStyle.fontSize = Number($("inpQFontSize").value || 16);
    updatePreviewBasics();
    renderPreviewCardFromQuestion(Editor.questions[0] || null);
  });

  $("inpQFontColor").addEventListener("input", ()=>{
    Editor.qStyle.color = $("inpQFontColor").value || "#eaf0ff";
    updatePreviewBasics();
  });

  $("chkLatex").addEventListener("change", ()=>{
    Editor.latex = $("chkLatex").checked;
    renderPreviewCardFromQuestion(Editor.questions[0] || null);
  });

  $("selBgmMode").addEventListener("change", ()=>{
    Editor.bgm.mode = $("selBgmMode").value;
    if (Editor.bgm.mode === "off"){
      Editor.bgm.dataUrl = "";
      $("fileBgm").value = "";
      toast("–ú—É–∑—ã–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞");
    }
  });

  $("fileBgm").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    Editor.bgm.dataUrl = await fileToDataUrl(f);
    Editor.bgm.mode = "upload";
    $("selBgmMode").value = "upload";
    toast("–ú—É–∑—ã–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
  });

  $("inpBgmVol").addEventListener("input", ()=>{
    const v = Number($("inpBgmVol").value ?? 0.6);
    Editor.bgm.volume = Math.max(0, Math.min(1, v));
  });

  $("selClickSound").addEventListener("change", ()=>{
    Editor.clickSound = $("selClickSound").value || "off";
  });

  $("btnTestClickSound").addEventListener("click", ()=>{
    playPreviewClickSound(Editor.clickSound);
  });

  $("btnStopClickSound").addEventListener("click", ()=>{
    stopPreviewClickSound();
    toast("–°—Ç–æ–ø");
  });

  $("selGameBgPreset").addEventListener("change", ()=>{
    Editor.gameBg.preset = $("selGameBgPreset").value;
    updatePreviewBasics();
  });

  $("fileGameBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    Editor.gameBg.uploadDataUrl = await fileToDataUrl(f);
    Editor.gameBg.preset = "upload";
    $("selGameBgPreset").value = "upload";
    updatePreviewBasics();
    toast("–§–æ–Ω –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω");
  });

  $("fileDeckBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    Editor.deckBackUrl = await fileToDataUrl(f);
    updatePreviewBasics();
    toast("–§–æ–Ω –∫–æ–ª–æ–¥—ã –∑–∞–≥—Ä—É–∂–µ–Ω");
  });

  $("fileFrontBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    Editor.frontBgUrl = await fileToDataUrl(f);
    updatePreviewBasics();
    toast("–§–æ–Ω –∫–∞—Ä—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω");
  });

  $("chkTimer").addEventListener("change", ()=>{
    Editor.timer.enabled = $("chkTimer").checked;
    updatePreviewBasics();
  });

  $("inpMinutes").addEventListener("input", ()=>{
    const v = Number($("inpMinutes").value || 0);
    Editor.timer.minutes = Math.max(0, v);
    updatePreviewBasics();
  });

  $("chkGlow").addEventListener("change", ()=>{
    Editor.glow.enabled = $("chkGlow").checked;
    updatePreviewBasics();
  });

  $("inpGlowColor").addEventListener("input", ()=>{
    Editor.glow.color = $("inpGlowColor").value || "#6aa4ff";
    updatePreviewBasics();
  });

  $("btnAddQ").addEventListener("click", ()=>openQuestionModal(null));

  $("btnClearQs").addEventListener("click", ()=>{
    Editor.questions = [];
    renderQuestionList();
    updatePreviewBasics();
    toast("–û—á–∏—â–µ–Ω–æ");
  });

  $("btnCloseModal").onclick = () => {
    Editor.draft=null;
    Editor.editingId=null;
    hideModal();
  };

  $("modalBackdrop").onclick = (e) => {
    if (e.target === $("modalBackdrop")) {
      Editor.draft=null;
      Editor.editingId=null;
      hideModal();
    }
  };

  $("selAnswerType").onchange = ()=>{
    const q = Editor.draft;
    if (!q) return;
    const t = $("selAnswerType").value;

    if (t === "choice"){
      q.answer = {
        type:"choice",
        options: q.answer?.options || ["",""],
        correctIndex: (Number.isFinite(q.answer?.correctIndex)?q.answer.correctIndex:0)
      };
      syncAnswerUI();
      renderChoiceUI();
    }
    else if (t === "text") {
      q.answer = { type:"text", accepts: q.answer?.accepts || [""] };
      syncAnswerUI();
      renderTextAnswersUI();
    }
    else {
      q.answer = { type:"free" };
      syncAnswerUI();
    }
  };

  $("inpPromptText").oninput = ()=>{
    const q = Editor.draft;
    if (!q) return;
    q.prompt.mode = "text";
    q.prompt.value = $("inpPromptText").value || "";
    updatePromptHint();
  };

  $("filePromptImage").onchange = async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const q = Editor.draft;
    if (!q) return;
    q.prompt.mode = "image";
    q.prompt.value = await fileToDataUrl(f);
    updatePromptHint();
    toast("–í–æ–ø—Ä–æ—Å-–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω");
  };

  $("filePromptAudio").onchange = async (e)=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const q = Editor.draft;
    if (!q) return;
    q.prompt.mode = "audio";
    q.prompt.value = await fileToDataUrl(f);
    updatePromptHint();
    toast("–ê—É–¥–∏–æ-–≤–æ–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∂–µ–Ω");
  };

  $("btnAddChoice").onclick = ()=>{
    const q = Editor.draft;
    if (!q) return;
    if (!q.answer.options) q.answer.options = ["",""];
    q.answer.options.push("");
    renderChoiceUI();
  };

  $("btnAddTextAnswer").onclick = ()=>{
    const q = Editor.draft;
    if (!q) return;
    if (!q.answer.accepts) q.answer.accepts = [];
    q.answer.accepts.push("");
    renderTextAnswersUI();
  };

  $("btnPreviewDraft").onclick = ()=>{
    const q = draftFromControls();
    if (!q) return;
    renderPreviewCardFromQuestion(q);
    toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é");
  };

  $("btnSaveQ").onclick = ()=>{
    const q = draftFromControls();
    if (!q) return;

    if (q.prompt.mode === "text" && !(q.prompt.value || "").trim()){
      toast("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞");
      return;
    }
    if (q.prompt.mode === "image" && !(q.prompt.value || "").trim()){
      toast("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤–æ–ø—Ä–æ—Å–∞");
      return;
    }
    if (q.prompt.mode === "audio" && !(q.prompt.value || "").trim()){
      toast("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –≤–æ–ø—Ä–æ—Å–∞");
      return;
    }

    if (q.answer.type === "choice"){
      const opts = (q.answer.options || []).map(x=>String(x||"").trim()).filter(Boolean);
      if (opts.length < 2){
        toast("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞");
        return;
      }
      q.answer.options = opts;
      q.answer.correctIndex = Number.isFinite(q.answer.correctIndex) ? q.answer.correctIndex : 0;
      if (q.answer.correctIndex >= q.answer.options.length) q.answer.correctIndex = 0;
    }
    else if (q.answer.type === "text") {
      const acc = (q.answer.accepts || []).map(x=>String(x||"").trim()).filter(Boolean);
      if (acc.length === 0){
        toast("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç");
        return;
      }
      q.answer.accepts = acc;
    }

    if (Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if (idx >= 0){
        q.id = Editor.editingId;
        Editor.questions[idx] = q;
        toast("–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
      } else {
        Editor.questions.push(q);
        toast("–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
      }
    }
    else{
      Editor.questions.push(q);
      toast("–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    }

    renderQuestionList();
    updatePreviewBasics();
    renderPreviewCardFromQuestion(q);

    Editor.draft=null;
    Editor.editingId=null;
    hideModal();
  };

  $("btnCopyCode").addEventListener("click", async ()=>{
    if (Editor.questions.length === 0){
      toast("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å");
      return;
    }

    const payload = {
      meta: Editor.meta,
      orderMode: Editor.orderMode,
      drawAnim: Editor.drawAnim,
      gameBg: Editor.gameBg,
      deckBackUrl: Editor.deckBackUrl,
      frontBgUrl: Editor.frontBgUrl,
      timer: Editor.timer,
      glow: Editor.glow,
      qStyle: Editor.qStyle,
      latex: Editor.latex,
      bgm: Editor.bgm,
      clickSound: Editor.clickSound,
      questions: Editor.questions
    };

    const hash = encodeCfgToHash(payload);
    const src = baseUrlNoQueryHash() + "?mode=game#" + hash;

    const iframeCode =
      '<iframe src="' + src + '" ' +
      'style="width:100%;height:720px;border:0;border-radius:18px;overflow:hidden;background:transparent" ' +
      'allow="autoplay; fullscreen" allowfullscreen loading="lazy"></iframe>';

    const ok = await copyToClipboard(iframeCode);
    toast(ok ? "–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
  });

  // —Å—Ç–∞—Ä—Ç
  updatePreviewBasics();
  renderQuestionList();

})();
</script>
</body>
</html>
